<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Drive Picker</title>

  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    #action-choices { margin-top: 1em; }
    pre { background: #f6f6f6; padding: 1em; white-space: pre-wrap; }
  </style>
</head>

<body>
{% if not creds %}
  <a href="{% url 'driveapp:login' %}">
    <button>Connect Google Drive</button>
  </a>
{% else %}
  <p>âœ… Drive connected.</p>

  <button id="picker">Pick Files/Folders</button>

  <div id="action-choices" style="display:none;">
    <button id="download-btn">Download</button><br>

    <input id="search-query"
           type="text"
           placeholder="Search files by name or contentâ€¦"
           style="margin-top:1em; width:300px;" />
    <button id="run-search">ğŸ” Search</button>
  </div>

  <pre id="picker-result"></pre>
{% endif %}

<script>
  const ALLOWED_MIME_TYPES = JSON.parse('{{ allowed_mimes|escapejs }}');
  const oauthToken         = "{{ creds.token|default:'' }}";
  const apiKey             = "{{ api_key }}";
  const csrftoken          = "{{ csrf_token }}";

  if (oauthToken) {
    let pickedDocs = null;

    document.getElementById('picker')
      .addEventListener('click', () =>
        gapi.load('picker', { callback: buildPicker })
      );

    function buildPicker() {
      const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
        .setIncludeFolders(true)
        .setSelectFolderEnabled(true)
        .setMimeTypes([
          ...ALLOWED_MIME_TYPES,
          'application/vnd.google-apps.folder'
        ].join(','));

      new google.picker.PickerBuilder()
        .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .setDeveloperKey(apiKey)
        .addView(view)
        .setOAuthToken(oauthToken)
        .setCallback(pickerCallback)
        .build()
        .setVisible(true);
    }

    function pickerCallback(data) {
      if (data.action !== google.picker.Action.PICKED) return;
      pickedDocs = data.docs;
      document.getElementById('action-choices').style.display = '';
      writeStatus('ğŸ”– Items selected. Choose an action.');
    }

    document.getElementById('download-btn').addEventListener('click', async function() {
      if (!pickedDocs) return;
      showActionChoices(false);
      writeStatus('ğŸ”– Downloading...');
      await fetch("{% url 'driveapp:metadata' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ docs: pickedDocs })
      }).catch(console.error);

      const res = await fetch("{% url 'driveapp:fetch' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ docs: pickedDocs })
      });

      if (!res.ok) {
        const txt = await res.text();
        writeStatus(`âŒ Download failed: ${txt}`);
        return;
      }

      const { downloaded } = await res.json();
      writeStatus(`âœ… Downloaded ${downloaded.length} file(s):\n` +
                  JSON.stringify(downloaded, null, 2));
      pickedDocs = null;
    });

    document.getElementById('run-search')
      .addEventListener('click', async () => {
        if (!pickedDocs || pickedDocs.length === 0) {
          writeStatus('âŒ No files or folders selected.');
          return;
        }
        const query = document.getElementById('search-query').value.trim();
        if (!query) {
          writeStatus('âŒ Empty search query.');
          return;
        }

        writeStatus(`ğŸ” Searching Drive for: â€œ${query}â€â€¦`);

        let data;
        try {
          const res = await fetch("{% url 'driveapp:search' %}", {
            method : 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken' : csrftoken
            },
            body: JSON.stringify({
              query       : query,
              selected_ids: pickedDocs.map(d => d.id)
            })
          });
          if (!res.ok) throw new Error(await res.text());
          data = await res.json();
        } catch (err) {
          writeStatus(`âŒ Search failed: ${err.message}`);
          return;
        }

        renderResults(query, data);
      });

    function renderBlock(label, list) {
      return list.length
        ? `${label} (${list.length}):\n` +
          list.map(d => `     â€¢ ${d.name} (${d.id})`).join('\n')
        : `${label} (0):\n   (none)`;
    }

    function renderResults(q, data) {
      const s = data.selected;
      const g = data.global;

      const selectedBlock =
        'ğŸ—‚ Selected:\n' +
        renderBlock('   â€” by name',     s.by_name)      + '\n' +
        renderBlock('   â€” by full text',s.by_fulltext);

      const globalBlock =
        'ğŸŒ All drives:\n' +
        renderBlock('   â€” by name',     g.by_name)      + '\n' +
        renderBlock('   â€” by full text',g.by_fulltext);

      writeStatus(
        `ğŸ” Results for â€œ${q}â€\n\n${selectedBlock}\n\n${globalBlock}`
      );
    }

    function writeStatus(msg) {
      document.getElementById('picker-result').textContent = msg;
    }
  }
</script>
</body>
</html>
